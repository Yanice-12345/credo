<script>
  const dictations = [/* ...inchangé... */];

  let currentDictationIndex = 0;
  let rate = 1;
  let paused = false;
  let currentUtterance = null;

  const userInput = document.getElementById("userInput");
  const feedback = document.getElementById("feedback");
  const select = document.getElementById("dictationSelect");

  function formatPunctuation(text) {
    return text
      .replace(/:/g, " deux-points ")
      .replace(/;/g, " point-virgule ")
      .replace(/\./g, " point ")
      .replace(/,/g, " virgule ")
      .replace(/!/g, " point d'exclamation ")
      .replace(/\?/g, " point d'interrogation ")
      .replace(/«|»/g, "")
      .replace(/-/g, " tiret ");
  }

  function speak(text, rate = 1) {
    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(formatPunctuation(text));
    utterance.lang = "fr-FR";
    utterance.rate = rate;
    currentUtterance = utterance;
    speechSynthesis.speak(utterance);
  }

  function playDictation() {
    paused = false;
    const dictationText = dictations[currentDictationIndex].text.join(" ");
    speak(dictationText, rate);
  }

  function pauseDictation() {
    if (!paused) {
      speechSynthesis.pause();
      paused = true;
    } else {
      speechSynthesis.resume();
      paused = false;
    }
  }

  function highlightMistakes(user, correct) {
    const userWords = user.split(/\s+/);
    const correctWords = correct.split(/\s+/);
    const result = [];

    for (let i = 0; i < correctWords.length; i++) {
      if (userWords[i] === correctWords[i]) {
        result.push(correctWords[i]);
      } else {
        result.push(`<span style="color: red;">${userWords[i] || "[manquant]"}</span>`);
      }
    }

    return result.join(" ");
  }

  function checkDictation() {
    const userText = userInput.value.trim().toLowerCase().replace(/[’']/g, "'");
    const correctText = dictations[currentDictationIndex].text.join(" ").toLowerCase().replace(/[’']/g, "'");

    const highlighted = highlightMistakes(userText, correctText);
    feedback.innerHTML = userText === correctText
      ? "✅ Bravo ! Vous avez parfaitement recopié la dictée."
      : `❌ Erreurs détectées :<br><br>${highlighted}`;
    feedback.style.color = userText === correctText ? "#00e676" : "#ff5252";
  }

  // Événements
  document.getElementById("btnPlay").onclick = playDictation;
  document.getElementById("btnPause").onclick = pauseDictation;
  document.getElementById("btnSlow").onclick = () => {
    rate = Math.max(0.25, rate - 0.25);
    playDictation();
  };
  document.getElementById("btnFast").onclick = () => {
    rate = Math.min(2, rate + 0.25);
    playDictation();
  };
  document.getElementById("btnCheck").onclick = checkDictation;
  select.onchange = () => {
    currentDictationIndex = parseInt(select.value);
    userInput.value = "";
    feedback.textContent = "";
  };
</script>
